<h1 id="Projections"><a class="section-marker" href="#Projections">ยง</a>Projections</h1>
<p>In Lagom, projections are processes consuming from a Persistent Entity Journal and handling each event via a <a href="ReadSide.html">read side table</a> or emitting it into a broker topic via a <a href="MessageBrokerApi.html#Implementing-a-topic">`TopicProducer`</a>. Here, Projections only refer to <code>ReadSideProcessors</code> and <code>TopicProducer</code>&lsquo;s&rsquo; (not Broker subscribers).</p>
<p>Lagom takes care to handle as many instances of your projection as <a href="ReadSide.html#Event-tags">shards</a> on your journal and then distribute those instances around the cluster so the load is balanced. By default, the multiple instances of your projection will be started but you can opt-out from that behavior using the setting:</p>
<pre class="prettyprint"><code>lagom.projection {
  auto-start.enabled = true
}
</code></pre><h2 id="Projection-status"><a class="section-marker" href="#Projection-status">ยง</a>Projection status</h2>
<p>Once up and running, you may query the state of your projections to ensure all the instances are up and running. You can also request a particular projection to stop or even a particular instance (aka worker) in a projection to stop. </p>
<p>Stopping and starting all the workers or a single worker of a projection is an asynchronous operation. Imagine we had a <code>ReadSideProcessor</code> called <code>users-by-name</code> that is reading the journal of a <code>Users</code> persistent entity and storing data into a SQL table. To stop that projection we would request the status of all workers to become <code>Stopped</code>. This request will propagate across the cluster and each node will make sure that any worker running locally that is part of the <code>users-by-name</code> projections is stopped. As workers switch from <code>Started</code> to <code>Stopped</code> they report back and we can <code>observe</code> their new status.</p>
<p>To request and modify the status of your projections inject a <code>Projections</code> instance in, for example, your <code>XyzServiceImpl</code> and use the provided methods.</p>
<pre class="prettyprint"><code class="language-java">    @Inject
    public UsersServiceImpl(Projections projections) {
      projections.stopAllWorkers(UsersByNameProcessor.NAME);
    }
</code></pre>
<p>The <em>requested status</em> is a volatile, in-memory value but it is replicated across your cluster. Only when the whole cluster is restarted you may have to request a particular status again. Also, because of its replicated nature, the <em>requested status</em> may be overwritten by multiple nodes on your cluster at the same time. The implementation is such that the <a href="https://doc.akka.io/docs/akka/current/distributed-data.html#data-types">last writer wins</a>.</p>
<p>When a new instance of a projection worker is created the rules to decide its status are:</p>
<ul>
  <li>if worker&rsquo;s requested status is known, use it; if not</li>
  <li>use the default value in <code>application.conf</code></li>
</ul>
<p>Because the <em>requested status</em> is a distributed, in-memory value, there is an edge case you will have to consider when you need a worker to be stopped. When starting a new node and having that node join an existing cluster, it is possible that some workers are spawned in the node before the <em>requested status</em> value is received from the peer nodes. In that case, the default <code>lagom.projection.auto-start.enabled</code> will be used to decide if the spawned worker should be stopped or started. If your default is <code>enabled = true</code> but the in-memory, replicated value is <code>Stopped</code> then there&rsquo;s a race condition and you could observe your worker <em>start-and-then-stop</em>. To prevent the <em>start-and-then-stop</em> behavior, opt-out of <code>lagom.projection.auto-start.enabled = true</code> and always handle worker startup using the methods <code>startAllWorkers</code>/<code>startWorker</code> on the <code>Projections</code> API.</p>